---
- name: access kubernetes
  hosts: omnisaas-admin
  become: yes
  vars_prompt:
    - name: k8sconfigfile
      #only support single cluster for using playbook,
      #if there was two or more pls use merge-kubeconfig.sh generated merged-kubeconfig file by manual 
      #/infrastructure/services/teleport/ansible/setup/roles/kubernetes/templates/scripts/merge-kubeconfig.sh
      
      #Usage:
      #merge-kubeconfig.sh config-1 config-2 

      #Change the name and location of automatically generated files as /root/.kube/kubeconfig
      #Notice: you still need to create developer and devops sa,clusterrole,clusterrolebind 
      #check services/teleport/ansible/setup/roles/kubernetes/templates/role directory.
      prompt: 'could you generated k8s config at /root/.kube/config? [yes / no]'
      default: 'no'
      private: false
    
    - name: kubernetes_env
      prompt: 'label kubernetes [project_name]'
      default: 'none'
      private: false

  vars:
    kube_enabled: 'yes'

  roles:
    - role: kubernetes 
      when: k8sconfigfile == 'yes'

  tasks:
    - name: Generating Configuration File
      block:
        - template:
            src: leaf-cluster/teleport.yaml
            dest: /etc/teleport.yaml
        - template:
            src: leaf-cluster/teleport.service
            dest: /usr/lib/systemd/system/teleport.service
        - systemd:
            name: teleport
            state: restarted
            enabled: yes
            daemon_reload: yes
      when: k8sconfigfile == 'yes'